/**
 * SoCump - Social App Browser Detection and Redirect (Minified Version)
 * ç®€åŒ–ç‰ˆæœ¬ï¼Œç”¨äºå¿«é€Ÿé›†æˆ
 */
(function(window) {
    'use strict';
    
    // æ£€æµ‹å‡½æ•°
    function isWeChat() {
        return /micromessenger/i.test(navigator.userAgent);
    }
    
    function isQQ() {
        return /qq\//i.test(navigator.userAgent) && !/mqqbrowser/i.test(navigator.userAgent);
    }
    
    function isQQBrowser() {
        return /mqqbrowser/i.test(navigator.userAgent);
    }
    
    function isAlipay() {
        return /alipayclient/i.test(navigator.userAgent);
    }
    
    function isWeibo() {
        return /weibo/i.test(navigator.userAgent);
    }
    
    function isInSocialApp() {
        return isWeChat() || isQQ() || isQQBrowser() || isAlipay() || isWeibo();
    }
    
    // è·å–ç›®æ ‡URL
    function getTargetUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('url') || params.get('target') || window.location.href;
    }
    
    // æ˜¾ç¤ºè·³è½¬æç¤º
    function showRedirectTip() {
        const targetUrl = getTargetUrl();
        const browserName = getBrowserName();
        
        // åˆ›å»ºæç¤ºç•Œé¢
        const overlay = document.createElement('div');
        overlay.innerHTML = `
            <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:99999;display:flex;align-items:center;justify-content:center;font-family:sans-serif;">
                <div style="background:white;padding:30px;border-radius:15px;max-width:350px;text-align:center;margin:20px;">
                    <div style="font-size:48px;margin-bottom:20px;">ğŸŒ</div>
                    <h2 style="margin:0 0 15px;color:#333;">è¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€</h2>
                    <p style="color:#666;margin-bottom:25px;line-height:1.5;">æ£€æµ‹åˆ°æ‚¨æ­£åœ¨${browserName}å†…ç½®æµè§ˆå™¨ä¸­è®¿é—®ï¼Œè¯·åœ¨å¤–éƒ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é“¾æ¥ã€‚</p>
                    <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:20px;word-break:break-all;font-size:14px;">${targetUrl}</div>
                    <button onclick="copyUrlAndClose()" style="width:100%;padding:12px;background:#007bff;color:white;border:none;border-radius:25px;font-size:16px;margin-bottom:10px;cursor:pointer;">å¤åˆ¶é“¾æ¥</button>
                    <button onclick="closeOverlay()" style="width:100%;padding:12px;background:#6c757d;color:white;border:none;border-radius:25px;font-size:16px;cursor:pointer;">å…³é—­</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // ç»‘å®šå…³é—­å‡½æ•°
        window.closeOverlay = function() {
            document.body.removeChild(overlay);
        };
        
        // ç»‘å®šå¤åˆ¶å‡½æ•°
        window.copyUrlAndClose = function() {
            copyToClipboard(targetUrl);
            setTimeout(closeOverlay, 1000);
        };
    }
    
    // è·å–æµè§ˆå™¨åç§°
    function getBrowserName() {
        if (isWeChat()) return 'å¾®ä¿¡';
        if (isQQ()) return 'QQ';
        if (isQQBrowser()) return 'QQæµè§ˆå™¨';
        if (isAlipay()) return 'æ”¯ä»˜å®';
        if (isWeibo()) return 'å¾®åš';
        return 'æµè§ˆå™¨';
    }
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(function() {
                showToast('é“¾æ¥å·²å¤åˆ¶');
            }).catch(function() {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    }
    
    // é™çº§å¤åˆ¶æ–¹æ¡ˆ
    function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            showToast('é“¾æ¥å·²å¤åˆ¶');
        } catch (err) {
            showToast('å¤åˆ¶å¤±è´¥');
        }
        
        document.body.removeChild(textArea);
    }
    
    // æ˜¾ç¤ºæç¤º
    function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:white;padding:10px 20px;border-radius:20px;z-index:100000;font-size:14px;';
        document.body.appendChild(toast);
        
        setTimeout(function() {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 2000);
    }
    
    // è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†
    function autoDetect() {
        const targetUrl = getTargetUrl();
        
        // å¦‚æœä¸åœ¨ç¤¾äº¤åº”ç”¨ä¸­ä¸”æœ‰ç›®æ ‡URLï¼Œç›´æ¥è·³è½¬
        if (!isInSocialApp() && targetUrl !== window.location.href) {
            window.location.href = targetUrl;
            return;
        }
        
        // å¦‚æœåœ¨ç¤¾äº¤åº”ç”¨ä¸­ï¼Œæ˜¾ç¤ºæç¤º
        if (isInSocialApp()) {
            showRedirectTip();
        }
    }
    
    // å¯¼å‡ºAPI
    window.SoCump = {
        isWeChat: isWeChat,
        isQQ: isQQ,
        isQQBrowser: isQQBrowser,
        isAlipay: isAlipay,
        isWeibo: isWeibo,
        isInSocialApp: isInSocialApp,
        showRedirectTip: showRedirectTip,
        copyToClipboard: copyToClipboard,
        autoDetect: autoDetect
    };
    
    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æµ‹
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', autoDetect);
    } else {
        autoDetect();
    }
    
})(window);