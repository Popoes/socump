/**
 * SoCump - Social App Browser Detection and Redirect (Minified Version)
 * 简化版本，用于快速集成
 */
(function(window) {
    'use strict';
    
    // 检测函数
    function isWeChat() {
        return /micromessenger/i.test(navigator.userAgent);
    }
    
    function isQQ() {
        return /qq\//i.test(navigator.userAgent) && !/mqqbrowser/i.test(navigator.userAgent);
    }
    
    function isQQBrowser() {
        return /mqqbrowser/i.test(navigator.userAgent);
    }
    
    function isAlipay() {
        return /alipayclient/i.test(navigator.userAgent);
    }
    
    function isWeibo() {
        return /weibo/i.test(navigator.userAgent);
    }
    
    function isInSocialApp() {
        return isWeChat() || isQQ() || isQQBrowser() || isAlipay() || isWeibo();
    }
    
    // 获取目标URL
    function getTargetUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('url') || params.get('target') || window.location.href;
    }
    
    // 显示跳转提示
    function showRedirectTip() {
        const targetUrl = getTargetUrl();
        const browserName = getBrowserName();
        
        // 创建提示界面
        const overlay = document.createElement('div');
        overlay.innerHTML = `
            <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:99999;display:flex;align-items:center;justify-content:center;font-family:sans-serif;">
                <div style="background:white;padding:30px;border-radius:15px;max-width:350px;text-align:center;margin:20px;">
                    <div style="font-size:48px;margin-bottom:20px;">🌐</div>
                    <h2 style="margin:0 0 15px;color:#333;">请在浏览器中打开</h2>
                    <p style="color:#666;margin-bottom:25px;line-height:1.5;">检测到您正在${browserName}内置浏览器中访问，请在外部浏览器中打开此链接。</p>
                    <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:20px;word-break:break-all;font-size:14px;">${targetUrl}</div>
                    <button onclick="copyUrlAndClose()" style="width:100%;padding:12px;background:#007bff;color:white;border:none;border-radius:25px;font-size:16px;margin-bottom:10px;cursor:pointer;">复制链接</button>
                    <button onclick="closeOverlay()" style="width:100%;padding:12px;background:#6c757d;color:white;border:none;border-radius:25px;font-size:16px;cursor:pointer;">关闭</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // 绑定关闭函数
        window.closeOverlay = function() {
            document.body.removeChild(overlay);
        };
        
        // 绑定复制函数
        window.copyUrlAndClose = function() {
            copyToClipboard(targetUrl);
            setTimeout(closeOverlay, 1000);
        };
    }
    
    // 获取浏览器名称
    function getBrowserName() {
        if (isWeChat()) return '微信';
        if (isQQ()) return 'QQ';
        if (isQQBrowser()) return 'QQ浏览器';
        if (isAlipay()) return '支付宝';
        if (isWeibo()) return '微博';
        return '浏览器';
    }
    
    // 复制到剪贴板
    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(function() {
                showToast('链接已复制');
            }).catch(function() {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    }
    
    // 降级复制方案
    function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            showToast('链接已复制');
        } catch (err) {
            showToast('复制失败');
        }
        
        document.body.removeChild(textArea);
    }
    
    // 显示提示
    function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:white;padding:10px 20px;border-radius:20px;z-index:100000;font-size:14px;';
        document.body.appendChild(toast);
        
        setTimeout(function() {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 2000);
    }
    
    // 自动检测和处理
    function autoDetect() {
        const targetUrl = getTargetUrl();
        
        // 如果不在社交应用中且有目标URL，直接跳转
        if (!isInSocialApp() && targetUrl !== window.location.href) {
            window.location.href = targetUrl;
            return;
        }
        
        // 如果在社交应用中，显示提示
        if (isInSocialApp()) {
            showRedirectTip();
        }
    }
    
    // 导出API
    window.SoCump = {
        isWeChat: isWeChat,
        isQQ: isQQ,
        isQQBrowser: isQQBrowser,
        isAlipay: isAlipay,
        isWeibo: isWeibo,
        isInSocialApp: isInSocialApp,
        showRedirectTip: showRedirectTip,
        copyToClipboard: copyToClipboard,
        autoDetect: autoDetect
    };
    
    // 页面加载完成后自动检测
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', autoDetect);
    } else {
        autoDetect();
    }
    
})(window);